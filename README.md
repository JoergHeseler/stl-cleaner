# STL Cleaner

## Overview

The STL Cleaner script validates and corrects STL files (ASCII and binary) by checking geometric integrity, ensuring counterclockwise vertex ordering, recalculating normals, and repositioning models to a defined minimum position. It outputs cleaned STL files ready for use in workflows like 3D printing or digital preservation.

## Background

Incorrect STL files can disrupt 3D workflows and archiving. Some popular 3D processing tools do not export 3D data to STL format strictly according to the [Marshall Burns specification](https://www.fabbers.com/tech/STL_Format). For example, MeshLab appends the generator name "STL generated by MeshLab" after the `solid` tag ad the name of the library, the Visualization and Computer Graphics Library, abbreviated as "vcg" after the `endsolid` tag. Furthermore, some vertex coordinates have negative values, which is not in accordance with the specification.
As part of this project, the STL Cleaner tool was developed to correct these deviations without altering the geometry of the stored model.

## Manifold Check with Blender

**Before applying the STL Cleaner, ensure that the model is manifold.** Non-manifold models can easily be corrected using 3D processing software like [Blender](https://www.blender.org/):

1. Open Blender and go to **Edit** > **Preferences** > **Get Extensions**.
2. Search for `3D Print Toolbox` and click on **Install**. **3D Print Toolbox** should be enabled now in the **Add-ons** tab.
3. Import your STL file (**File** > **Import** > **STL**).
4. Press `N` to open the right-side panel and select the **3D Print** tab.
5. In **Edit Mode**, select the model (`A`).
6. Use the **3D Print Toolbox** options:
   - Click **Check All** to identify issues.
   - Click **Make Manifold** to fix non-manifold geometry.
7. Recheck the model and export it as a cleaned STL (**File** > **Export** > **STL**).

## Apply STL Cleaner

Once the model has been confirmed as manifold, the STL Cleaner is used to correct any remaining deviations from the specification. This ensures that the STL file is fully compliant and can be archived without any issues.
The following table compares a cube with side length 2 as an uncleaned and cleaned STL file:

| Line | Uncleaned and invalid STL file       | Cleaned and valid STL file                    |
| ---- | ------------------------------------ | --------------------------------------------- |
| 1    | **solid** _STL generated by MeshLab_ | **solid** _STL generated by MeshLab \| vcg_   |
| 2    | **facet normal** 0 0 1               | &nbsp;**facet normal** 0.0 0.0 1.0            |
| 3    | &nbsp;**outer loop**                 | &nbsp;&nbsp;**outer loop**                    |
| 4    | &nbsp;&nbsp;**vertex** 1 1 1         | &nbsp;&nbsp;&nbsp;**vertex** _2.01 2.01 2.01_ |
| 5    | &nbsp;&nbsp;**vertex** _-1_ 1 1      | &nbsp;&nbsp;&nbsp;**vertex** _0.01 2.01 2.01_ |
| 6    | &nbsp;&nbsp;**vertex** _-1 -1_ 1     | &nbsp;&nbsp;&nbsp;**vertex** _0.01 0.01 2.01_ |
| 7    | &nbsp;**endloop**                    | &nbsp;&nbsp;**endloop**                       |
| 8    | **endfacet**                         | &nbsp;**endfacet**                            |
|      | ⋮                                    | &nbsp;⋮                                       |
| 79   | **facet normal** 0 1 0               | &nbsp;**facet normal** 0.0 1.0 0.0            |
| 80   | &nbsp;**outer loop**                 | &nbsp;&nbsp;**outer loop**                    |
| 81   | &nbsp;&nbsp;**vertex** _-1_ 1 _-1_   | &nbsp;&nbsp;&nbsp;**vertex** _0.01 2.01 0.01_ |
| 82   | &nbsp;&nbsp;**vertex** 1 1 1         | &nbsp;&nbsp;&nbsp;**vertex** _2.01 2.01 2.01_ |
| 83   | &nbsp;&nbsp;**vertex** 1 1 _-1_      | &nbsp;&nbsp;&nbsp;**vertex** _2.01 2.01 0.01_ |
| 84   | &nbsp;**endloop**                    | &nbsp;&nbsp;**endloop**                       |
| 85   | **endfacet**                         | &nbsp;**endfacet**                            |
| 86   | **endsolid** _vcg_                   | **endsolid** _STL generated by MeshLab vcg_   |

## Usage

1. Download [**stl-cleaner.py**](./src/stl-cleaner.py).
2. In the command line run `python stl-cleaner.py <STL file> [options]`

### Options

| Option                         | Description                                            |
| ------------------------------ | ------------------------------------------------------ |
| `--o=<output file path>`       | path to the corrected output STL file output           |
| `--indent=<number of spaces>`  | indentation spaces, default=1                          |
| `--min-pos=<minimum position>` | mininum allowed model position, default=0.01,0.01,0.01 |
| `--force-repos`                | always repositions the model to the minimum position   |
| `--ignore-endsolid-name`       | only considers the solid name                          |
| `--warnings`                   | prints all warning information to standard output      |

## Dependencies

[Python 2.4](https://www.python.org/download/releases/2.4/) and [Blender 4.4](https://www.blender.org/download/releases/4-4/) were used develop and test this script.

## Related Projects

- [NFDI4Culture 3D Reference Implementations](https://git.slub-dresden.de/nfdi4culturedigitalpreservation/nfdi4culture-3d-reference-implementations)

## Contributing

Contributions are welcome! Please open an issue or submit a pull request.

## Acknowledgments

Special thanks to the colleagues from the SLUB Dresden, specifically from the Infrastructure and Long-Term Availability division, for their support and valuable feedback during the development.

## Imprint

[NFDI4Culture](https://nfdi4culture.de/) – Consortium for Research Data on Material and Immaterial Cultural Heritage.
Funded by the German Research Foundation (DFG), Project No. [441958017](https://gepris.dfg.de/gepris/projekt/441958017).

**Author**: [Jörg Heseler](https://orcid.org/0000-0002-1497-627X)
**License**: [CC BY-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/)
